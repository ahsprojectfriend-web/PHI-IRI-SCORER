<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHI-IRI Grade 7 | Screening Tool</title>
    <style>
        :root {
            --google-blue: #1a73e8; --google-light-blue: #e8f0fe;
            --google-red: #d93025; --google-green: #1e8e3e;
            --google-gray: #5f6368; --background: #f8f9fa;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--background); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; max-width: 800px; width: 100%; padding: 40px; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        
        .settings-btn { position: absolute; top: 20px; right: 20px; background: #eee; border: 1px solid #ccc; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 24px; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .classroom-header { background: #1e8e3e; color: white; padding: 10px; text-align: center; border-radius: 24px 24px 0 0; margin: -40px -40px 20px -40px; }
        h1, h2, h3 { color: var(--google-blue); text-align: center; margin-top: 10px; }
        
        #timer-display { font-size: 4rem; text-align: center; color: var(--google-red); font-family: monospace; margin: 15px 0; font-weight: bold; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
        .btn { padding: 12px 30px; border-radius: 50px; cursor: pointer; border: 1px solid #dadce0; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--google-blue); color: white; border: none; }
        .btn-danger { background: white; color: var(--google-red); }
        .btn-success { background: var(--google-green); color: white; border: none; width: 100%; margin-top: 20px; }
        .btn:disabled { background: #f1f3f4; color: #9aa0a6; cursor: not-allowed; }

        #passage-area { border: 1px solid #dadce0; padding: 30px; border-radius: 16px; line-height: 2.2; font-size: 1.2rem; background: var(--google-light-blue); margin-bottom: 20px; }
        .word { display: inline-block; padding: 0 3px; cursor: pointer; border-radius: 4px; }
        .word.error { background: var(--google-red); color: white; text-decoration: line-through; }

        .question-block { background: #fdfdfd; padding: 25px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 20px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .option-btn { padding: 12px; border: 1px solid #dadce0; border-radius: 10px; background: white; cursor: pointer; text-align: left; font-size: 1rem; }
        .option-btn.selected { background: var(--google-blue); color: white; border-color: var(--google-blue); }

        .info-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .field label { display: block; font-size: 12px; color: var(--google-gray); margin-bottom: 5px; font-weight: bold; }
        .field input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 10px; box-sizing: border-box; }

        #results-summary { display: none; padding: 35px; border-radius: 20px; text-align: center; margin-top: 25px; }
        .Independent { background: #e6f4ea; color: #137333; border: 3px solid #1e8e3e; }
        .Instructional { background: #fef7e0; color: #b06000; border: 3px solid #f9ab00; }
        .Frustration { background: #fce8e6; color: #c5221f; border: 3px solid #d93025; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(4px); overflow-y: auto;}
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 35px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; margin-top: 15px; }
        .settings-grid label { font-size: 11px; font-weight: bold; color: var(--google-gray); }
        textarea { width: 100%; height: 80px; padding: 10px; border-radius: 10px; border: 1px solid #dadce0; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <button class="settings-btn" onclick="openSettings()">⚙️</button>

    <div id="setup-step">
        <div class="classroom-header">PHI-IRI Grade 7 Reading Assessment</div>
        <h1>Student Profile</h1>
        <div class="info-grid">
            <div class="field"><label>Full Name</label><input type="text" id="studentName"></div>
            <div class="field"><label>Grade</label><input type="text" id="gradeLevel" value="7"></div>
            <div class="field"><label>Section</label><input type="text" id="sectionName"></div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="startPart(0)">Start Assessment</button>
    </div>

    <div id="active-step" style="display:none;">
        <h2 id="step-title">PART 1</h2>
        <div id="timer-ui">
            <div id="timer-display">10:00</div>
            <div class="controls">
                <button id="startBtn" class="btn btn-primary" onclick="beginReading()">Start Reading</button>
                <button id="stopBtn" class="btn btn-danger" onclick="endReading()" disabled>Stop Reading</button>
            </div>
        </div>
        <div id="passage-container">
            <div id="passage-area"></div>
        </div>
        <div id="quiz-container" style="display:none;">
            <h3>Reading Comprehension</h3>
            <div id="quiz-area"></div>
            <button id="nextBtn" class="btn btn-success" onclick="goToNextStep()">Continue</button>
        </div>
    </div>

    <div id="results-summary"></div>
    <button id="submitBtn" class="btn btn-primary" style="display:none; width:100%; margin-top:15px;" onclick="sendData()">Submit to Google Sheets</button>
    <button id="resetBtn" class="btn" style="display:none; width:100%; margin-top:10px;" onclick="location.reload()">New Assessment</button>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h2>Admin Configuration</h2>
        <label style="font-size: 11px; font-weight: bold; color: var(--google-gray);">GOOGLE APPS SCRIPT URL</label>
        <textarea id="sheetUrl"></textarea>
        
        <hr>
        <h3>Scoring Thresholds (%)</h3>
        <div class="settings-grid">
            <div>
                <label>INDEPENDENT WORD READING (Min %)</label>
                <input type="number" id="t_ind_word" value="97">
            </div>
            <div>
                <label>INDEPENDENT COMP. (Min %)</label>
                <input type="number" id="t_ind_comp" value="80">
            </div>
            <div>
                <label>INSTRUCTIONAL WORD READING (Min %)</label>
                <input type="number" id="t_ins_word" value="90">
            </div>
            <div>
                <label>INSTRUCTIONAL COMP. (Min %)</label>
                <input type="number" id="t_ins_comp" value="59">
            </div>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="saveConfig()">Save All Settings</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="closeSettings()">Close</button>
    </div>
</div>

<script>
    // Hardcoded passages and questions from your document
    const data = [
        {
            title: "PART 1: Telling Time",
            text: "Humans have used different objects to tell time. In the beginning, they used an hourglass. This is a cylindrical glass with a narrow center which allows sand to flow from its upper to its lower portion. Once all the sand has trickled to the lower portion, one knows that an hour has passed. Using the same idea, water clocks were constructed to measure time by having water flow through a narrow passage from one container to another. On the other hand, sundials allowed people to estimate an hour by looking at the position of the shadow cast by the sun on a plate. At night, people measured time by checking the alignment of the stars in the sky. None of these were accurate, though. The clock was the first accurate instrument for telling time.",
            questions: [
                { q: "Which of the following ways of telling time made use of sand?", options: ["water clocks", "hourglass", "sundials", "clock"], correct: 1 },
                { q: "Accurate in the sentence means:", options: ["free from error", "comparable", "very useful", "efficient"], correct: 0 },
                { q: "When men of long ago told time at night, they looked at the:", options: ["cloud formation", "moon", "stars", "sun"], correct: 2 },
                { q: "The sundials may not be useful in telling time:", options: ["at noontime", "in the morning", "during a rainy day", "when the sun shines brightly"], correct: 2 },
                { q: "How are the hourglass and the water clock similar?", options: ["Both tell time by the hour.", "Both use water to tell time.", "Both are used only in the daytime.", "Both have a narrow center through which flows."], correct: 3 },
                { q: "The best title of the selection is:", options: ["The Uses of Clocks", "Why People Need to Tell Time", "Ways of Telling Time: Then and Now", "Comparing Types of Clocks"], correct: 2 },
                { q: "Which of these sentences is a topic sentence?", options: ["The clock 600 years ago...", "Hourglass contained sand...", "Long ago people used simple tools...", "Humans have used different objects to tell the time."], correct: 3 }
            ]
        },
        {
            title: "PART 2: Counting the Hours",
            text: "When men decided to divide the day into twenty-four hours, they used numbers one through twelve two times. As a result, there was one o’clock during the day and another one o’clock after midnight. This created confusion. If one was told to submit a project at six o’clock, did this mean six o’clock in the morning or at night? The Romans provided a solution to this problem. They thought that noon time, the time when the sun is at its apex, is an important time. They called noon Meridies and measured time by this. They called the morning ante meridiem, which means “before noon” while “after noon” was called post meridiem. Ante meridiem was shortened to A.M. while post meridiem was shortened to P.M.",
            questions: [
                { q: "When the day was divided into 24 hours, what numbers were used?", options: ["one to six", "one to twelve", "one to thirty-six", "one to twenty-four"], correct: 1 },
                { q: "In this selection confusion may mean:", options: ["differences", "discussions", "problems", "mistakes"], correct: 2 },
                { q: "The Romans thought of a solution. This means they provided:", options: ["an answer to the problem", "a better interpretation", "a new set of numbers", "another clock"], correct: 0 },
                { q: "Meridies means:", options: ["apex", "noon", "before", "daylight"], correct: 1 },
                { q: "Early Romans used the sun. When it was at its apex, it was noon. Apex means:", options: ["highest point", "lowest point", "farthest point", "nearest point"], correct: 0 },
                { q: "Another good title for this selection is:", options: ["Why There Are 24 Hours", "Importance of Noontime", "How the Romans Told Time", "The Meaning of A.M. and P.M."], correct: 3 }
            ]
        },
        {
            title: "PART 3: Nosebleeds",
            text: "Having a nosebleed is a common occurrence. Children experience epistaxis when blood flows out from either or both nostrils, often for a short period of time. It may be caused by one’s behavior like frequent nose picking or blowing too hard when one has a cold. It may also be caused by certain physical factors such as an allergy or abnormal growths in the nasal cavity. Or it may be due to environmental conditions such as exposure to toxic fumes or dryness of the air. While it is often thought that holding one’s head back can treat a nosebleed, this can actually cause one to choke or vomit. The best thing to do is to lean forward, pinch the top of the nose and apply a cold compress. And if that doesn’t work, it’s best to get professional help.",
            questions: [
                { q: "When children experience epistaxis, we observe:", options: ["steady flow of nasal discharge", "blood flow from nasal passage", "build up of mucus", "blood stoppage"], correct: 1 },
                { q: "A 'common occurrence' is:", options: ["incident that is disappointing", "episode that is alarming", "event that is no longer surprising", "occasion that is overwhelming"], correct: 2 },
                { q: "Which helps treat a nosebleed?", options: ["applying a cold compress", "pinching the nostrils shut", "holding head back", "applying warm compress"], correct: 0 },
                { q: "Which of these causes are within our control?", options: ["allergies", "picking one's nose", "dryness in air", "abnormal growth"], correct: 1 },
                { q: "Which factors are directly within our control?", options: ["physical", "environmental", "behavioral", "social"], correct: 2 },
                { q: "This selection is mainly providing:", options: ["description of a nosebleed", "causes and effects", "explanation of treatment", "listing of myths"], correct: 2 },
                { q: "Another good title for this selection is:", options: ["A Cause for Concern", "An Unavoidable Experience", "Common Childhood Experience", "Common Myths and Misconceptions"], correct: 2 }
            ]
        }
    ];

    let currentPart = 0, totalMiscues = 0, totalTime = 0, totalCorrect = 0, timer, startTime, answers = [];

    function openSettings() { 
        document.getElementById('settingsModal').style.display = 'block'; 
        document.getElementById('sheetUrl').value = localStorage.getItem('phil_iri_url') || "";
        document.getElementById('t_ind_word').value = localStorage.getItem('t_ind_word') || 97;
        document.getElementById('t_ind_comp').value = localStorage.getItem('t_ind_comp') || 80;
        document.getElementById('t_ins_word').value = localStorage.getItem('t_ins_word') || 90;
        document.getElementById('t_ins_comp').value = localStorage.getItem('t_ins_comp') || 59;
    }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveConfig() {
        localStorage.setItem('phil_iri_url', document.getElementById('sheetUrl').value);
        localStorage.setItem('t_ind_word', document.getElementById('t_ind_word').value);
        localStorage.setItem('t_ind_comp', document.getElementById('t_ind_comp').value);
        localStorage.setItem('t_ins_word', document.getElementById('t_ins_word').value);
        localStorage.setItem('t_ins_comp', document.getElementById('t_ins_comp').value);
        alert("Settings Saved!"); closeSettings();
    }

    function startPart(idx) {
        if(!document.getElementById('studentName').value) return alert("Enter Student Name");
        currentPart = idx;
        document.getElementById('setup-step').style.display = 'none';
        document.getElementById('active-step').style.display = 'block';
        document.getElementById('step-title').innerText = data[currentPart].title;
        const area = document.getElementById('passage-area');
        area.innerHTML = '';
        data[currentPart].text.split(' ').forEach(w => {
            const s = document.createElement('span'); s.className = 'word'; s.innerText = w + ' ';
            s.onclick = function() { this.classList.toggle('error'); };
            area.appendChild(s);
        });
        document.getElementById('timer-ui').style.display = 'block';
        document.getElementById('passage-container').style.display = 'block';
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('startBtn').disabled = false; document.getElementById('stopBtn').disabled = true;
    }

    function beginReading() {
        startTime = Date.now(); document.getElementById('startBtn').disabled = true; document.getElementById('stopBtn').disabled = false;
        let sRem = 600;
        timer = setInterval(() => {
            sRem--; const m = Math.floor(sRem/60), s = sRem%60;
            document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            if(sRem <= 0) endReading();
        }, 1000);
    }

    function endReading() {
        clearInterval(timer); totalTime += (Date.now() - startTime) / 1000;
        totalMiscues += document.querySelectorAll('.word.error').length;
        document.getElementById('timer-ui').style.display = 'none'; document.getElementById('passage-container').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'block'; renderQuiz();
    }

    function renderQuiz() {
        const area = document.getElementById('quiz-area'); area.innerHTML = '';
        data[currentPart].questions.forEach((q, i) => {
            let html = `<div class="question-block"><p><strong>${i+1}. ${q.q}</strong></p><div class="options-grid">`;
            q.options.forEach((opt, oIdx) => { html += `<button class="option-btn p${currentPart}-q${i}" onclick="selectOpt(${i}, ${oIdx})">${opt}</button>`; });
            area.innerHTML += html + '</div></div>';
        });
    }

    function selectOpt(qIdx, oIdx) {
        answers[qIdx] = oIdx;
        document.querySelectorAll(`.p${currentPart}-q${qIdx}`).forEach(b => b.classList.remove('selected'));
        event.target.classList.add('selected');
    }

    function goToNextStep() {
        data[currentPart].questions.forEach((q, i) => { if(answers[i] === q.correct) totalCorrect++; });
        answers = []; if(currentPart < 2) startPart(currentPart + 1); else showFinal();
    }

    function showFinal() {
        document.getElementById('active-step').style.display = 'none';
        const totalW = 382;
        const accuracy = ((totalW - totalMiscues) / totalW) * 100;
        const wpm = (totalW / totalTime) * 60;
        const comp = (totalCorrect / 20) * 100;

        // Get Dynamic Thresholds
        const tIndW = parseInt(localStorage.getItem('t_ind_word') || 97);
        const tIndC = parseInt(localStorage.getItem('t_ind_comp') || 80);
        const tInsW = parseInt(localStorage.getItem('t_ins_word') || 90);
        const tInsC = parseInt(localStorage.getItem('t_ins_comp') || 59);

        let profile = "Frustration";
        if (accuracy >= tIndW && comp >= tIndC) profile = "Independent";
        else if (accuracy >= tInsW && comp >= tInsC) profile = "Instructional";

        const res = document.getElementById('results-summary');
        res.style.display = 'block'; res.className = profile;
        res.innerHTML = `<h2>Profile: ${profile}</h2><p>Accuracy: ${accuracy.toFixed(1)}% | Speed: ${wpm.toFixed(0)} WPM | Comp: ${totalCorrect}/20</p>`;
        document.getElementById('submitBtn').style.display = 'block'; document.getElementById('resetBtn').style.display = 'block';
    }

    async function sendData() {
        const url = localStorage.getItem('phil_iri_url');
        const payload = { timestamp: new Date().toLocaleString(), name: document.getElementById('studentName').value, grade: document.getElementById('gradeLevel').value, section: document.getElementById('sectionName').value, accuracy: ((382-totalMiscues)/3.82).toFixed(1)+"%", wpm: (382/totalTime*60).toFixed(0), profile: document.getElementById('results-summary').className };
        if(!url) return alert("Set URL in Gear!");
        try { await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }); alert("Sent!"); } catch(e) { alert("Error"); }
    }
</script>
</body>
</html>